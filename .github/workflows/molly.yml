name: Molly

on:
  push:
    paths: .github/workflows/molly.yml
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:


    - name: Download latest tarBall
      uses: robinraju/release-downloader@v1.3
      with: 
        repository: "mollyim/mollyim-android"
        latest: true
        tarBall: true

    - name: Extract source code
      run: |
        tar -xzf "$(find . -type f -name *.tar.gz)"
        mv -f "$(find . -maxdepth 1 -type d -name "*molly*")/*" .
        rm -f "$(find . -type f -name *.tar.gz)"

    - name: Install dependencies
      run: |
        sudo apt-get update || sudo apt-get update
        sudo apt-get install -y openjdk-11-jdk-headless ccache
        sudo update-alternatives --auto java

    - name: Cache ccache
      id: ccache-cache
      uses: actions/cache@main
      with:
        path: ${{ github.workspace }}/.ccache
        key: ccache-${{ github.sha }}
        restore-keys: ccache-

    - name: Setup ccache
      run: |
        sudo /usr/sbin/update-ccache-symlinks
        echo 'export PATH="/usr/lib/ccache:$PATH"' | tee -a ~/.bashrc
        echo 'export CCACHE_EXEC=/usr/bin/ccache' | tee -a ~/.bashrc
        echo 'export USE_CCACHE=1' | tee -a ~/.bashrc
        source ~/.bashrc

    - name: Build Molly
      run: ./gradlew -Pci --no-daemon :app:assembleProdNonFreeRelease

    - name: Download release repo
      uses: actions/checkout@main
      with:
        path: rel

    - name: Create a release
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      working-directory: rel
      run: gh release create -d -t "$GITHUB_WORKFLOW on $(date "+%A, %d of %B of %Y")" $(date "+%y.%m.%d.%H.%M.%S") $(find ../app/build/outputs/apk -name *.apk -type f)

    - run: ls -R .
      if: always()

    - name: Upload unsigned APKs
      uses: actions/upload-artifact@main
      with:
        name: outputs
        path: |
          app/build/outputs/apk
