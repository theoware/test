name: Test

on:
  push:
    paths: .github/workflows/test.yml

jobs:

  build:
    name: Build
    runs-on: windows-2022

    defaults:
      run:
        shell: cmd
        working-directory: ${{ github.workspace }}

    steps:
      - name: Prepare directories
        run: |
          mkdir TBuild\Libraries
          mkdir TBuild\Libraries64
          echo TBUILD=TBuild>>%GITHUB_ENV%

      - name: Get repository name
        shell: bash
        run: |
          REPO=kotatogram/kotatogram-desktop
          echo "REPO_NAME=${REPO##*/}" >> $GITHUB_ENV

      - name: Native Tools Command Prompt
        uses: ilammy/msvc-dev-cmd@d8610e2b41c6d0f0c3b4c46dad8df0fd826c68e1

      - name: Clone
        uses: actions/checkout@d50f8ea76748df49594d9b109b614f3b4db63c71
        with:
          submodules: recursive
          path: ${{ env.TBUILD }}\${{ env.REPO_NAME }}
          repository: kotatogram/kotatogram-desktop

      - name: Choco dependencies
        run: |
          choco install --no-progress -y nasm strawberryperl yasm jom ninja
          py -m pip install pywin32

      - name: Install msys64
        run: |
          mkdir %TBUILD%\ThirdParty
          mklink /d %TBUILD%\ThirdParty\msys64\ C:\msys64\

      - name: Set up environment paths
        shell: bash
        run: |
          echo "C:\\Strawberry\\perl\\bin\\" >> $GITHUB_PATH
          echo "C:\\Program Files\\NASM\\" >> $GITHUB_PATH
          echo "C:\\ProgramData\\chocolatey\\lib\\ninja\\tools\\" >> $GITHUB_PATH

          echo "Configurate git for cherry-picks."
          git config --global user.email "you@example.com"
          git config --global user.name "Sample"

      - name: NuGet sources
        run: |
          nuget sources Disable -Name "Microsoft Visual Studio Offline Packages"
          nuget sources Add -Source https://api.nuget.org/v3/index.json & exit 0

      - name: Libraries cache
        id: cache-libs
        uses: actions/cache@2d8d0d1c9b41812b6fd3d4ae064360e7d8762c7b
        with:
          path: |
            ${{ env.TBUILD }}/Libraries*/**/output*/*
            ${{ env.TBUILD }}/Libraries*/**/build*/*
          key: Windows-libs-766c2f63e256240462a2adfeed2576bc0d5d2527
          restore-keys: ${{ runner.OS }}-libs-

      - name: Libraries
        env:
          GYP_MSVS_OVERRIDE_PATH: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\'
          GYP_MSVS_VERSION: 2022
        if: steps.cache-libs.outputs.cache-hit != 'true'
        run: |
          cd %TBUILD%
          %REPO_NAME%/Telegram/build/prepare/win.bat skip-release

      - name: Read defines
        shell: bash
        run: |
          DEFINE=""
          if [ -n "${{ matrix.defines }}" ]; then
            DEFINE="-D ${{ matrix.defines }}=ON"
            echo Define from matrix: $DEFINE
            echo "ARTIFACT_NAME=Kotatogram_${{ matrix.defines }}" >> $GITHUB_ENV
          else
            echo "ARTIFACT_NAME=Kotatogram" >> $GITHUB_ENV
          fi
          echo "TDESKTOP_BUILD_DEFINE=$DEFINE" >> $GITHUB_ENV

      - name: Free up some disk space
        run: |
          cd %TBUILD%
          del /S Libraries\*.pdb
          del /S Libraries\*.pch
          del /S Libraries\*.obj
          del /S Libraries64\*.pdb
          del /S Libraries64\*.pch
          del /S Libraries64\*.obj

      - name: Free up some disk space
        run: |
          cd %TBUILD%
          del /q /S /a:- **\*output*\* /a:- **\*build*\* /a:- **\*out*\* Libraries64\*

      - run: dir /s
        if: always()
